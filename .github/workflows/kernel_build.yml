# GitHub Actions Workflow: Enhanced Custom Kernel Build

name: Enhanced Custom Kernel Build

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: 'Kernel source repository (e.g., user/repo)'
        required: true
        default: 'Dark-Matter7232/CosmicFresh-Hanoip'
      kernel_branch:
        description: 'Kernel source branch'
        required: true
        default: 'main'
      defconfig_name:
        description: 'Kernel defconfig file name'
        required: true
        default: 'hanoip_defconfig'
      clang_repo:
        description: 'Clang toolchain repository (e.g., user/repo)'
        required: true
        default: 'kdrag0n/proton-clang'
      clang_branch:
        description: 'Clang toolchain branch'
        required: true
        default: 'master'
      zip_name:
        description: 'Name of the final flashable zip (without .zip)'
        required: true
        default: 'CosmicFresh-Hanoip-Kernel'
      image_name:
        description: 'Name of the kernel image to package'
        required: true
        default: 'Image.gz-dtb' # Common alternatives: Image.gz, Image
      apply_legacy_fixes:
        description: 'Apply specific patches for older kernel sources?'
        type: boolean
        default: true

# Centralized environment variables for the job
env:
  TZ: "Asia/Kolkata" # Set timezone for accurate timestamps

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    
    steps:
      - name: ‚è±Ô∏è Initialize Build Environment
        run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: üì¶ Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git build-essential flex bison libssl-dev libelf-dev ccache bc libz-dev wget python3 zip

      - name: ‚ö° Setup Toolchain Caching
        uses: actions/cache@v4
        id: toolchain-cache
        with:
          path: |
            clang-toolchain
            gcc64
            gcc32
          key: toolchain-${{ runner.os }}-${{ github.event.inputs.clang_repo }}-${{ github.event.inputs.clang_branch }}

      - name: ‚öôÔ∏è Download Toolchains (if not cached)
        if: steps.toolchain-cache.outputs.cache-hit != 'true'
        run: |
          echo "Cache not found. Cloning toolchains..."
          git clone --depth=1 https://github.com/${{ github.event.inputs.clang_repo }} -b ${{ github.event.inputs.clang_branch }} clang-toolchain
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 gcc64
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 gcc32
        
      - name: üìö Checkout Kernel and AnyKernel3 Sources
        run: |
          git clone --depth=1 https://github.com/${{ github.event.inputs.kernel_repo }} -b ${{ github.event.inputs.kernel_branch }} kernel_source
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel3

      - name: üîß Set up Build Environment Variables
        run: |
          echo "Setting up environment variables..."
          # Add toolchains to PATH
          echo "PATH=$(pwd)/clang-toolchain/bin:$(pwd)/gcc64/bin:$(pwd)/gcc32/bin:$PATH" >> $GITHUB_ENV
          
          # Set kernel build variables
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-androideabi-" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

      - name: ü©π Apply Legacy Fixes (Optional)
        if: github.event.inputs.apply_legacy_fixes == true
        working-directory: ./kernel_source
        run: |
          echo "Applying legacy fixes..."
          # Fix for Python 2 print syntax in Python 3
          sed -i 's/print(line,, file=sys.stderr)/print(line, file=sys.stderr)/g' scripts/gcc-wrapper.py
          # Fix for byte string issues in Python 3
          sed -i "s/line\.rstrip('\\n')/line.decode('utf-8').rstrip('\\n')/g" scripts/gcc-wrapper.py
          # Remove unsupported CPU flags from Makefile
          sed -i '/-mcpu/d' Makefile

      - name: üöÄ Compile Kernel
        working-directory: ./kernel_source
        run: |
          # Configure the kernel
          make O=out ${{ github.event.inputs.defconfig_name }}
          
          # Optional fix for stack protector, common on older sources
          if ${{ github.event.inputs.apply_legacy_fixes }}; then
              sed -i 's/CONFIG_CC_STACKPROTECTOR_STRONG=y/# CONFIG_CC_STACKPROTECTOR_STRONG is not set/g' out/.config
          fi
          
          # Build the kernel
          echo "Starting kernel compilation..."
          make O=out -j$(nproc --all)
          
          # Verify that the kernel image was built
          if [ ! -f "out/arch/arm64/boot/${{ github.event.inputs.image_name }}" ]; then
              echo "Kernel image not found! Build failed."
              exit 1
          fi

      - name: üì¶ Package with AnyKernel3
        run: |
          echo "Packaging into a flashable zip..."
          cp kernel_source/out/arch/arm64/boot/${{ github.event.inputs.image_name }} anykernel3/
          cd anykernel3
          zip -r9 ${{ github.event.inputs.zip_name }}.zip . -x ".git*" -x "README.md" -x "*placeholder"
          
      - name: ‚¨ÜÔ∏è Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.zip_name }}
          path: anykernel3/${{ github.event.inputs.zip_name }}.zip

      - name: üìä Post-Build Summary
        if: always() # This step will run even if previous steps fail
        run: |
          BUILD_END_TIME=$(date +%s)
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          echo "========================================"
          echo "  BUILD SUMMARY"
          echo "========================================"
          echo "Status: ${{ job.status }}"
          echo "Total build time: $((BUILD_DURATION / 60)) minutes and $((BUILD_DURATION % 60)) seconds."
          echo "========================================"
